<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Podlove Publisher Client Development Environment</title>
    <link rel="shortcut icon" href="#" />
  </head>

  <body class="bg-gray-500 p-2">
    <div data-client="podlove">
      <podlove-media-files></podlove-media-files>
      <div class="h-5"></div>
      <podlove-auphonic></podlove-auphonic>
      <div class="h-5"></div>
      <podlove-description></podlove-description>
      <div class="h-5"></div>
      <podlove-chapters></podlove-chapters>
      <div class="h-5"></div>
      <podlove-transcripts></podlove-transcripts>
      <div class="h-5"></div>
      <podlove-contributors></podlove-contributors>
      <div class="h-5"></div>
      <podlove-related-episodes></podlove-related-episodes>
      <div class="h-5"></div>
      <podlove-soundbite></podlove-soundbite>
    </div>

    <script type="module" src="./src/client.ts"></script>
    <script src="./config.local.js"></script>

    <script>
      window.addEventListener('load', () => {
        // Use config from external file config.local.js
        const config = window.devConfig || {};
        const user = config.user || 'admin';
        const applicationPassword = config.applicationPassword || '';
        const baseUrl = config.baseUrl || 'http://publisher.local';

        // First fetch the JS hook to get the variables
        fetch(`${baseUrl}/?hook=podlove-js-hook`)
          .then(response => response.text())
          .then(jsContent => {
            // Create and execute the script to set the variables
            const script = document.createElement('script');
            script.textContent = jsContent;
            document.body.appendChild(script);

            // Continue with the episode initialization after variables are set
            return fetch(`${baseUrl}/wp-json/podlove/v2/episodes`);
          })
          .then((res) => res.json())
          .then(({ results }) => {
            if (!results.length) {
              throw new Error('Missing Episodes')
            }

            return results[0]
          })
          .then((episode) =>
            fetch(`${baseUrl}/wp-json/podlove/v2/episodes/${episode.id}`)
          )
          .then((res) => res.json())
          .then(({ id, post_id }) => {
            const data = {
              baseUrl: baseUrl,
              api: {
                base: `${baseUrl}/wp-json/podlove`,
                auth: btoa(`${user}:${applicationPassword}`),
              },
              post: {
                id: post_id,
              },
              episode: {
                id,
              },
            }

            const mergedData = { ...data, ...window.PODLOVE_DATA }
            window.initPodloveUI(mergedData)
          })
          .catch(error => {
            console.error('Error initializing Podlove UI:', error);
          });
      })
    </script>
  </body>
</html>
